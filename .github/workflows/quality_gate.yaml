name: Quality Gate (Nightly)

on:
  workflow_dispatch:
  schedule:
    - cron: "30 2 * * *"   # daily 02:30 UTC
  push:
    branches: [ main ]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      BASELINE_GOLDEN: data/baselines/ci_golden_metrics.json
      BASELINE_HARD: data/baselines/ci_hard_metrics.json
      REDIS_URL: redis://localhost:6379/0

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: System dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------------
      # Start Async Infrastructure
      # -------------------------------
      - name: Start Celery Worker
        run: |
          nohup celery -A apps.workers.celery_app worker \
            --loglevel=info \
            --concurrency=2 \
            --max-tasks-per-child=50 \
            > celery.log 2>&1 &

      - name: Start API Gateway
        shell: bash
        run: |
          set -euo pipefail

          nohup python -m uvicorn apps.api_gateway.main:app \
            --host 127.0.0.1 \
            --port 8000 \
            --log-level info \
            > uvicorn.log 2>&1 &

          # Health check
          python - << 'PY'
          import time, sys, requests
          url = "http://127.0.0.1:8000/health"
          for _ in range(60):
              try:
                  if requests.get(url, timeout=1).status_code == 200:
                      print("Gateway ready")
                      sys.exit(0)
              except Exception:
                  pass
              time.sleep(1)
          print("Gateway failed to start")
          sys.exit(1)
          PY

      # -------------------------------
      # Evaluation Runs (ASYNC)
      # -------------------------------
      - name: Eval (golden)
        run: |
          python tools/eval_harness/run_eval.py \
            --test-dir data/test_cases/golden \
            --out-dir artifacts/eval_runs/ci_golden \
            --gateway http://127.0.0.1:8000 \
            --name ci_golden \
            --timeout-s 180 \
            --batch-size 4

      - name: Eval (hard)
        run: |
          python tools/eval_harness/run_eval.py \
            --test-dir data/test_cases/hard \
            --out-dir artifacts/eval_runs/ci_hard \
            --gateway http://127.0.0.1:8000 \
            --name ci_hard \
            --timeout-s 240 \
            --batch-size 4

      # -------------------------------
      # Quality Gates
      # -------------------------------
      - name: Quality gate (golden) — blocking
        run: |
          python tools/eval_harness/quality_gate.py \
            --metrics artifacts/eval_runs/ci_golden/metrics.json \
            --baseline "${BASELINE_GOLDEN}" \
            --min-ok-rate 0.99 \
            --min-valid-rate 0.99 \
            --allow-valid-drop 0.01

      - name: Quality gate (hard) — non-blocking
        continue-on-error: true
        run: |
          python tools/eval_harness/quality_gate.py \
            --metrics artifacts/eval_runs/ci_hard/metrics.json \
            --baseline "${BASELINE_HARD}" \
            --min-ok-rate 0.95 \
            --min-valid-rate 0.02 \
            --allow-valid-drop 0.01

      # -------------------------------
      # Debug Artifacts
      # -------------------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-quality-gate
          path: |
            artifacts/eval_runs
            uvicorn.log
            celery.log
