name: Quality Gate (Nightly)

on:
  workflow_dispatch:
  schedule:
    - cron: "30 2 * * *"  # daily 02:30 UTC

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      BASELINE_GOLDEN: data/baselines/ci_golden.metrics.json
      BASELINE_HARD: data/baselines/ci_hard.metrics.json

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps (full stack)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start API gateway
        run: |
          nohup python -m uvicorn apps.api_gateway.main:app --host 127.0.0.1 --port 8000 > uvicorn.log 2>&1 &
          python - << 'PY'
          import time, sys
          import requests
          url = "http://127.0.0.1:8000/health"
          for _ in range(60):
              try:
                  r = requests.get(url, timeout=1)
                  if r.status_code == 200:
                      print("ready")
                      sys.exit(0)
              except Exception:
                  pass
              time.sleep(1)
          print("gateway not ready")
          sys.exit(1)
          PY

      - name: Eval (golden)
        run: |
          python tools/eval_harness/run_eval.py \
            --test-dir data/test_cases/golden \
            --gateway http://127.0.0.1:8000 \
            --endpoint /extract/batch \
            --name ci_golden \
            --timeout-s 180 \
            --batch-size 4 \
            --no-base64-fallback

      - name: Eval (hard)
        run: |
          python tools/eval_harness/run_eval.py \
            --test-dir data/test_cases/hard \
            --gateway http://127.0.0.1:8000 \
            --endpoint /extract/batch \
            --name ci_hard \
            --timeout-s 240 \
            --batch-size 4 \
            --no-base64-fallback

      - name: Locate latest metrics paths
        shell: bash
        run: |
          echo "GOLDEN_METRICS=$(ls -td artifacts/eval_runs/*_ci_golden/ | head -n 1)/metrics.json" >> $GITHUB_ENV
          echo "HARD_METRICS=$(ls -td artifacts/eval_runs/*_ci_hard/ | head -n 1)/metrics.json" >> $GITHUB_ENV

      - name: Quality gate (golden) - blocking
        run: |
          python tools/eval_harness/quality_gate.py \
            --metrics "${GOLDEN_METRICS}" \
            --baseline "${BASELINE_GOLDEN}" \
            --min-ok-rate 0.99 \
            --min-valid-rate 0.99 \
            --allow-valid-drop 0.01

      - name: Quality gate (hard) - non-blocking
        continue-on-error: true
        run: |
          python tools/eval_harness/quality_gate.py \
            --metrics "${HARD_METRICS}" \
            --baseline "${BASELINE_HARD}" \
            --min-ok-rate 0.95 \
            --min-valid-rate 0.02 \
            --allow-valid-drop 0.01

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-quality-gate
          path: |
            artifacts/eval_runs
            uvicorn.log
